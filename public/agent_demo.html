<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Agent Demo (Streaming on Vercel Edge)</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 1rem; }
    #chat { max-width: 780px; margin: 0 auto; }
    .msg { padding: .6rem .8rem; border-radius: .6rem; margin: .4rem 0; white-space: pre-wrap; }
    .user { background: #eef; align-self: flex-end; }
    .assistant { background: #f6f6f6; }
    #messages { display: flex; flex-direction: column; }
    #inputRow { display: flex; gap: .5rem; margin-top: .5rem; }
    input, button { font-size: 1rem; padding: .6rem; }
    input { flex: 1; }
  </style>
</head>
<body>
  <div id="chat">
    <h2>Agent Demo (Azure OpenAI streaming via /api/agent/stream)</h2>
    <div id="messages"></div>
    <div id="inputRow">
      <input id="prompt" placeholder="Ask something..."/>
      <button id="send">Send</button>
    </div>
  </div>

  <script>
    const messages = document.getElementById('messages');
    const promptInput = document.getElementById('prompt');
    const sendBtn = document.getElementById('send');

    function addMsg(text, role) {
      const div = document.createElement('div');
      div.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
      div.textContent = text || '';
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      return div;
    }

    async function send() {
      const q = promptInput.value.trim();
      if (!q) return;
      addMsg(q, 'user');
      promptInput.value = '';
      const assistantDiv = addMsg('â€¦', 'assistant');

      const res = await fetch('/api/agent/stream', {
        method: 'POST',
        headers: {'content-type': 'application/json'},
        body: JSON.stringify({ message: q })
      });

      if (!res.ok || !res.body) {
        assistantDiv.textContent = 'Error contacting agent.';
        return;
      }

      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      let full = '';

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });

        const chunks = buffer.split('\n\n');
        buffer = chunks.pop() || '';

        for (const chunk of chunks) {
          const line = chunk.split('\n').find(l => l.startsWith('data:'));
          if (!line) continue;
          const data = line.slice(5).trim();
          try {
            const obj = JSON.parse(data);
            if (obj.text) {
              full += obj.text;
              assistantDiv.textContent = full;
            }
          } catch {}
        }
      }
    }

    sendBtn.addEventListener('click', send);
    promptInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') send(); });
  </script>
</body>
</html>
