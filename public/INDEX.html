<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>dealBreaker – Chat Demo</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background:#f8fafc; color:#0f172a; margin:0 }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); padding:20px; }
    .chat-interface { border:1px solid #e2e8f0; border-radius:10px; height: 480px; display:flex; flex-direction:column; background:#fff; }
    .chat-messages { flex:1; padding:16px; overflow-y:auto; background:#f1f5f9; }
    .message { margin: 10px 0; padding: 10px 12px; border-radius:10px; max-width:80%; line-height:1.5 }
    .message-user { background:#1e40af; color:#fff; margin-left:auto }
    .message-bot { background:#fff; border:1px solid #e2e8f0 }
    .chat-input { padding: 12px; border-top:1px solid #e2e8f0; display:flex; gap:8px; }
    .form-control { flex:1; padding: 12px; border:1px solid #cbd5e1; border-radius:8px; font-size:15px }
    .btn { background:#1e40af; color:#fff; border:none; padding: 10px 16px; border-radius:8px; cursor:pointer; font-weight:600 }
    .btn:hover { background:#1d4ed8 }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="margin-bottom:10px"><i class="fas fa-robot"></i> dealBreaker – OpenAI Streaming Chat</h1>
    <p style="color:#475569; margin-bottom:20px">Type a message and watch the response stream token-by-token via SSE.</p>
    <div class="card">
      <div class="chat-interface">
        <div id="chatMessages" class="chat-messages">
          <div class="message message-bot"><strong>AI Assistant:</strong> Hi! Ask me anything.</div>
        </div>
        <div class="chat-input">
          <input id="chatInput" class="form-control" placeholder="Say hi..." onkeypress="handleChatEnter(event)"/>
          <button class="btn" onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>
  </div>

<script>
function addMessage(text, type) {
  const messages = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = `message message-${type}`;
  div.innerHTML = (type === 'user')
    ? `<strong>You:</strong> ${text}`
    : `<strong>AI Assistant:</strong> ${text}`;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
  return div;
}

async function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message) return;
  addMessage(message, 'user');
  input.value = '';

  const thinking = addMessage('', 'bot');

  // Stream from our Next.js API (SSE)
  const res = await fetch('/api/agent', {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({ message })
  });

  if (!res.ok || !res.body) {
    thinking.innerHTML = '<strong>AI Assistant:</strong> Error contacting server.';
    return;
  }

  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let buffer = '';
  let full = '';

  while (true) {
    const { value, done } = await reader.read();
    if (done) break;
    buffer += decoder.decode(value, { stream: true });

    const chunks = buffer.split('\n\n');
    buffer = chunks.pop() || '';

    for (const chunk of chunks) {
      const line = chunk.split('\n').find(l => l.startsWith('data:'));
      if (!line) continue;
      const data = line.slice(5).trim();
      if (data === '[DONE]') continue;
      try {
        const obj = JSON.parse(data);
        if (obj.text) {
          full += obj.text;
          thinking.innerHTML = `<strong>AI Assistant:</strong> ${full}`;
        }
      } catch (e) {}
    }
  }
}

function handleChatEnter(e) {
  if (e.key === 'Enter') sendChatMessage();
}
</script>
</body>
</html>
